"""
Esse programa faz parte do Trabalho de Redes de Computadores II 
"""
__author__ = "Gabriel Hishida and Allan Cedric"

import socket

HOST = "127.0.0.1"  # (localhost)
PORT_TO_LISTEN = 65010
PORTS = [64000, 64001, 64002]


server_sockets = []
for port in PORTS:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        s.connect((HOST, port))
        server_sockets.append(s)
    
    except ConnectionRefusedError: 
        print(f"Error: Could not connect to server {PORTS.index(port)}")
        exit()


listen_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
listen_sock.bind((HOST, PORT_TO_LISTEN))

while True:
    # Wait for client
    listen_sock.listen()
    conn, addr = listen_sock.accept()
    print(f"Connected to CLIENT by {addr}")

    while(True):
        data = conn.recv(1024)
        if not data:
            break
        

        try:
            data = eval(data)
            print(f"Received request {data}")

        except:
            pass
        

        if data in range(len(server_sockets)):

            try:
                server_sockets[data].sendall(f"temperature from server {data}".encode("utf-8"))
            except BrokenPipeError:
                conn.sendall(f"err: Could not connect to server {data}".encode("utf-8"))
            
            server_sockets[data].settimeout(1.0)
            
            try:
                response = server_sockets[data].recv(1024)

                if response:
                    temperature = eval(response)
                    conn.sendall(str(temperature).encode("utf-8"))
                else:
                    conn.sendall(f"err: Could not connect to server {data}".encode("utf-8"))

            except socket.timeout:
                conn.sendall(f"err: Could not connect to server {data}".encode("utf-8"))
        
        else:
            print(f"Requested server {data} does not exist")
            conn.sendall(f"err: Server {data} does not exist".encode("utf-8"))


